# 定时任务须知 🕐

## 🎯 核心功能

基于最新`每日自动执行.py`，实现山东省152个地区气象数据的**全自动收集与存储**，具备**智能重试机制**确保数据完整性。

## ⚡ 主要流程

```
系统检查 → JWT生成 → 数据收集（重试机制） → 数据存储 → 统计报告
```

### 1️⃣ 系统检查
- ✅ MySQL连接验证
- ✅ 网络连通性测试  
- ✅ 必要文件完整性检查
- ⚠️ 任一检查失败立即终止

### 2️⃣ JWT Token生成
- 🔑 自动生成10小时有效期的JWT令牌
- ⚡ 失败则个任务终止

### 3️⃣ 数据收集（关键逻辑）
- **覆盖范围**：山东省152个地区
- **数据类型**：小时级数据 + 每日级数据
- **重试机制**：
  - 正间隔：城市间1秒
  - 失败重试：2s→4s→8s（指数退避）
  - 成功策略：一旦成功立即停止重试
  - 最大重试：每个城市最多3次机会

### 4️⃣ 数据存储
- **小时数据**：按地区分组批量存储
- **每日数据**：每个地区单记录
- **更新机制**：重复数据自动更新

### 5️⃣ 统计报告
- 📊 成功/失败城市数量统计
- 📈 数据库总体数据量报告
- 🔍 最新数据时间戳检查

## ⏰ 执行安排

| 项目 | 详情 |
|---|---|
| **执行时间** | 每天上午11:00整 |
| **执行周期** | 每日自动执行 |
| **预计耗时** | 5-8分钟（含重试时间） |
| **成功标准** | 数据完整度≥95% |

## 📁 关键文件

### 核心脚本
- **`每日自动执行.py`**：主执行脚本（已更新重试机制）
- **`com.weather.daily.plist`**：macOS定时配置文件

### 数据文件
- **`全国城市（区分省）/山东省.csv`**：152个地区列表
- **日志文件**：`logs/daily_weather_YYYYMMDD.log`

### 备份文件
- **`每日自动执行.py.backup`**：原始版本备份

## 🔍 实时监控

### 查看今日执行状态
```bash
# 检查任务是否加载
launchctl list | grep com.weather.daily

# 查看今日详细日志
cat logs/daily_weather_$(date +%Y%m%d).log

# 实时监控日志输出
tail -f logs/daily_weather_$(date +%Y%m%d).log
```

### 关键日志识别
- ✅ `✅ 成功获取`：数据收集成功
- 🔄 `🔄 正在重试`：进入重试模式
- ❌ `❌ 已重试3次仍失败`：最终失败记录

## 🚨 故障排查

### 常见问题速查

| 现象 | 可能原因 | 解决方案 |
|---|---|---|
| 任务未执行 | 系统未运行/任务未加载 | 检查`launchctl list` |
| JWT生成失败 | 密钥配置问题 | 检查JWT配置 |
| 数据收集失败 | 网络/API问题 | 查看重试日志 |
| 大量重试 | API限制/网络不稳 | 检查网络状态 |

### 手动测试命令
```bash
# 手动执行一次（测试用）
python3 每日自动执行.py

# 重启定时任务
launchctl unload ~/Library/LaunchAgents/com.weather.daily.plist
launchctl load ~/Library/LaunchAgents/com.weather.daily.plist
```

## 📊 性能指标

### 数据质量目标
- **成功率**：≥95%（152个城市中至少145个成功）
- **重试效率**：平均每个城市耗时＜3秒
- **数据完整性**：无遗漏城市，无重复数据

### 日志分析要点
```bash
# 统计今日成功城市数
grep "成功获取" logs/daily_weather_$(date +%Y%m%d).log | wc -l

# 查找所有失败城市
grep "已重试3次仍失败" logs/daily_weather_$(date +%Y%m%d).log
```

## 🔄 任务管理

### 启动/停止任务
```bash
# 加载任务（首次使用）
launchctl load ~/Library/LaunchAgents/com.weather.daily.plist

# 卸载任务（暂停）
launchctl unload ~/Library/LaunchAgents/com.weather.daily.plist

# 修改时间后重启
launchctl unload ~/Library/LaunchAgents/com.weather.daily.plist
launchctl load ~/Library/LaunchAgents/com.weather.daily.plist
```
# 命令行
 # 修改后重新加载                                                                     
      cd /Users/incarnation/Desktop/准动（银豹）/气象数据收集/                     
      launchctl unload ~/Library/LaunchAgents/com.weather.daily.plist 2>/dev/null    
      launchctl load ~/Library/LaunchAgents/com.weather.daily.plist     
# 验证是否成功加载                                                                   
      launchctl list | grep com.weather.daily 

### 修改执行时间
编辑`com.weather.daily.plist`中的：
```xml
<key>Hour</key><integer>11</integer>  <!-- 小时 (0-23) -->
<key>Minute</key><integer>0</integer> <!-- 分钟 (0-59) -->
```

## ⚠️ 重要提醒

1. **系统要求**：Mac需在11:00处于开机状态   #最大问题
2. **网络要求**：确保能访问天气API
3. **数据库要求**：MySQL服务必须正常运行
4. **日志保留**：建议保留最近7天日志用于问题分析
5. **手动备份**：每月备份一次数据库数据

## 🎯 验证清单

首次部署后请确认：
- [ ] 定时任务已加载：`launchctl list | grep com.weather.daily`
- [ ] 今日日志已生成并包含成功记录
- [ ] 数据库中今日数据已更新
- [ ] 重试机制正常工作（可通过手动测试验证）

---

**版本更新**：本指南基于2025年8月5日更新的重试机制版本